name: Release Datapack

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Debug - Show repository structure
        run: |
          echo "=== Root directory ==="
          ls -la
          echo ""
          echo "=== new_versions folder ==="
          ls -la new_versions/ || echo "ERROR: new_versions not found!"
          echo ""
          echo "=== All folders in new_versions ==="
          ls -1 new_versions/ || echo "Empty or not found"
          echo ""
          echo "=== Looking for datapack folders ==="
          find new_versions -type d -name "datapack" 2>/dev/null || echo "No datapack folders found"
          echo ""
          echo "=== Full tree ==="
          find new_versions -type f 2>/dev/null | head -20 || echo "No files"
      
      - name: Get Latest Version
        id: version
        run: |
          latest=$(ls -1 new_versions/ 2>/dev/null | sort -V | tail -n 1)
          
          if [ -z "$latest" ]; then
            echo "::error::No version folders found in new_versions/"
            echo "Available folders:"
            ls -la new_versions/ || echo "new_versions does not exist"
            exit 1
          fi
          
          echo "mc_version=$latest" >> $GITHUB_OUTPUT
          echo "tag_name=v$latest" >> $GITHUB_OUTPUT
          echo "::notice::Found version: $latest"
          
          mcmeta="new_versions/$latest/datapack/pack.mcmeta"
          if [ -f "$mcmeta" ]; then
            pack_format=$(grep -oP '"pack_format"\s*:\s*\K\d+' "$mcmeta" 2>/dev/null || echo "1")
          else
            echo "::warning::pack.mcmeta not found at $mcmeta"
            pack_format="1"
          fi
          
          echo "pack_format=$pack_format" >> $GITHUB_OUTPUT
      
      - name: Validate Datapack
        run: |
          DIR="new_versions/${{ steps.version.outputs.mc_version }}/datapack"
          
          echo "Checking directory: $DIR"
          
          if [ ! -d "$DIR" ]; then
            echo "::error::Datapack directory not found: $DIR"
            echo "Directory structure:"
            ls -R "new_versions/${{ steps.version.outputs.mc_version }}/" || echo "Version folder not found"
            exit 1
          fi
          
          if [ ! -f "$DIR/pack.mcmeta" ]; then
            echo "::error::pack.mcmeta not found"
            ls -la "$DIR"
            exit 1
          fi
          
          if [ ! -d "$DIR/data" ]; then
            echo "::error::data folder not found"
            ls -la "$DIR"
            exit 1
          fi
          
          echo "âœ… Datapack structure is valid"
          ls -R "$DIR" | head -50
      
      - name: Create ZIP
        run: |
          DIR="new_versions/${{ steps.version.outputs.mc_version }}/datapack"
          ZIP="mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip"
          
          cd "$DIR"
          zip -r "$GITHUB_WORKSPACE/$ZIP" . -x "*.git*" -x ".DS_Store"
          
          cd "$GITHUB_WORKSPACE"
          echo "ZIP created:"
          ls -lh "$ZIP"
          echo ""
          echo "ZIP contents (first 30 lines):"
          unzip -l "$ZIP" | head -30
      
      - name: Generate Changelog
        id: changelog
        run: |
          PREV=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREV" ]; then
            CHANGES="Initial release for Minecraft ${{ steps.version.outputs.mc_version }}"
          else
            CHANGES=$(git log ${PREV}..HEAD --oneline --no-merges -- "new_versions/${{ steps.version.outputs.mc_version }}/datapack/**" 2>/dev/null | sed 's/^/- /' || echo "- Updated datapack")
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Delete existing release if exists
        continue-on-error: true
        run: |
          gh release delete "${{ steps.version.outputs.tag_name }}" --yes 2>/dev/null || true
          git push --delete origin "${{ steps.version.outputs.tag_name }}" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: "MC Server Toolkit v${{ steps.version.outputs.mc_version }}"
          body: |
            ## ðŸ“¦ Minecraft Server Toolkit Datapack
            
            **Minecraft Version:** `${{ steps.version.outputs.mc_version }}`
            **Pack Format:** `${{ steps.version.outputs.pack_format }}`
            
            ### ðŸ“ Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ### ðŸš€ Installation
            1. Download ZIP below
            2. Place in `datapacks` folder
            3. Run `/reload`
            
            ### ðŸ› Issues
            [Report here](https://github.com/${{ github.repository }}/issues)
          files: mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        if: success()
        run: |
          echo "## âœ… Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.mc_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
