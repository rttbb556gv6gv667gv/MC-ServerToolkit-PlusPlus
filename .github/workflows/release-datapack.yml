name: Release Datapack
on:
  push:
    branches:
      - main
    paths:
      - 'new_versions/**/datapack/**'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Get Latest Version
        id: version
        run: |
          latest_version=$(find new_versions -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort -V | tail -n 1)
          if [ -z "$latest_version" ]; then
            echo "::error::No versions found in new_versions/"
            exit 1
          fi
          echo "mc_version=$latest_version" >> $GITHUB_OUTPUT
          echo "::notice::Found Minecraft version: $latest_version"
          
          mcmeta_file="new_versions/$latest_version/datapack/pack.mcmeta"
          if [ -f "$mcmeta_file" ]; then
            pack_format=$(grep '"pack_format"' "$mcmeta_file" | grep -o '[0-9]\+' | head -n 1)
            pack_format=${pack_format:-1}
          else
            echo "::warning::pack.mcmeta not found, using default pack_format=1"
            pack_format="1"
          fi
          
          echo "version=v${latest_version}" >> $GITHUB_OUTPUT
          echo "pack_format=${pack_format}" >> $GITHUB_OUTPUT
          echo "::notice::Pack format: $pack_format"
      
      - name: Validate Datapack
        run: |
          datapack_path="new_versions/${{ steps.version.outputs.mc_version }}/datapack"
          if [ ! -d "$datapack_path" ]; then
            echo "::error::Datapack directory not found: $datapack_path"
            exit 1
          fi
          if [ ! -d "$datapack_path/data" ]; then
            echo "::error::Invalid datapack: missing data folder"
            exit 1
          fi
          echo "::notice::Datapack structure validated"
      
      - name: Package Datapack
        run: |
          cd new_versions/${{ steps.version.outputs.mc_version }}/datapack
          zip -r -q "$GITHUB_WORKSPACE/mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip" . -x '*/\.*' -x '\.*'
          file_size=$(du -h "$GITHUB_WORKSPACE/mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip" | cut -f1)
          echo "::notice::Created ZIP package: $file_size"
          
      - name: Verify ZIP
        run: |
          echo "::group::ZIP Contents"
          unzip -l mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip
          echo "::endgroup::"
          if ! unzip -l mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip | grep -q "pack.mcmeta"; then
            echo "::error::pack.mcmeta not found in ZIP"
            exit 1
          fi
          echo "::notice::ZIP validated successfully"
      
      - name: Generate Changelog
        id: changelog
        run: |
          previous_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$previous_tag" ]; then
            changes=$(git log ${previous_tag}..HEAD --pretty=format:"- %s" --no-merges -- "new_versions/${{ steps.version.outputs.mc_version }}/datapack/**" 2>/dev/null || echo "")
            if [ -n "$changes" ]; then
              echo "changes<<EOF" >> $GITHUB_OUTPUT
              echo "$changes" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "changes=No changes recorded" >> $GITHUB_OUTPUT
            fi
          else
            echo "changes=Initial release" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "MC Server Toolkit for Minecraft ${{ steps.version.outputs.mc_version }}"
          files: mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip
          body: |
            ## ðŸ“¦ Minecraft Server Toolkit Datapack
            
            ### ðŸ“‹ Information
            - **Minecraft Version:** `${{ steps.version.outputs.mc_version }}`
            - **Pack Format:** `${{ steps.version.outputs.pack_format }}`
            - **Commit:** `${{ github.sha }}`
            
            ### ðŸ“ Changes
            ${{ steps.changelog.outputs.changes }}
            
            ### ðŸš€ Installation
            1. Download `mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip` below
            2. Place in your world's `datapacks` folder
            3. Run `/reload` in-game
            4. Verify with `/datapack list`
            
            ### ðŸ“¥ Download
            [â¬‡ï¸ mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip)
            
            ### â„¹ï¸ Requirements
            - Minecraft Java Edition ${{ steps.version.outputs.mc_version }}+
            - Datapack support enabled
            
            ### ðŸ› Report Issues
            [Open an issue](https://github.com/${{ github.repository }}/issues) if you encounter problems.
            
            ---
            *Auto-generated by GitHub Actions*
          draft: false
          prerelease: false
          make_latest: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        if: success()
        run: |
          echo "### âœ… Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Minecraft Version:** ${{ steps.version.outputs.mc_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pack Format:** ${{ steps.version.outputs.pack_format }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
