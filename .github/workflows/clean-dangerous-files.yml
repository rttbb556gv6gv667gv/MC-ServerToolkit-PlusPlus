name: Clean Dangerous Files

on:
  push:
    paths:
      - "new_versions/**"
  pull_request:
    paths:
      - "new_versions/**"
  workflow_dispatch:

jobs:
  clean-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan and delete dangerous files
        id: scan
        run: |
          set -euo pipefail

          echo "üîç Scanning for dangerous files"

          DANGEROUS_EXTENSIONS=("sh" "js" "exe" "bat" "cmd" "ps1" "py" "rb" "pl" "jar" "dll" "so" "dylib" "vbs" "com" "msi" "app" "deb" "rpm")
          DELETED_FILES=()

          FIND_PATTERN=""
          for ext in "${DANGEROUS_EXTENSIONS[@]}"; do
            FIND_PATTERN="$FIND_PATTERN -o -name *.$ext"
          done
          FIND_PATTERN="${FIND_PATTERN# -o }"

          while IFS= read -r -d '' file; do
            echo "‚ö†Ô∏è Found: $file"

            if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
              ext="${file##*.}"
              echo "::error file=$file,title=Security violation::.$ext files are not allowed in datapacks."
              DELETED_FILES+=("$file")
            else
              rm -f "$file"
              echo "üóëÔ∏è Deleted: $file"
              DELETED_FILES+=("$file")
            fi
          done < <(
            find new_versions -type f \( $FIND_PATTERN \) -path "*datapack*" -print0 2>/dev/null | sort -zu
          )

          COUNT="${#DELETED_FILES[@]}"
          echo "file_count=$COUNT" >> "$GITHUB_OUTPUT"

          if [ "$COUNT" -gt 0 ]; then
            printf '%s\n' "${DELETED_FILES[@]}" | sort -u > deleted_files.log
            if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
              exit 1
            fi
          fi

      - name: Commit changes
        if: github.event_name != 'pull_request' && steps.scan.outputs.file_count != '0'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "üõ°Ô∏è Security: removed dangerous files"
          git push

      - name: Upload deletion log
        if: always() && steps.scan.outputs.file_count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: deletion-log
          path: deleted_files.log

      - name: Summary
        if: always()
        run: |
          echo "## üõ°Ô∏è Datapack Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** $GITHUB_EVENT_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Deleted files:** ${{ steps.scan.outputs.file_count }}" >> $GITHUB_STEP_SUMMARY
