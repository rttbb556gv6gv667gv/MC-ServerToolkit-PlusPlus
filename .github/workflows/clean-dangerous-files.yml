name: Clean Dangerous Files

on:
  push:
    paths:
      - 'new_versions/**'
  workflow_dispatch:
  pull_request:
    paths:
      - 'new_versions/**'

jobs:
  clean-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Scan and delete dangerous files
        id: scan
        run: |
          set -euo pipefail
          
          echo "üîç Scanning for dangerous files in new_versions/*datapack*"
          
          # Tehlikeli uzantƒ±lar (datapack-only repo i√ßin)
          # NOT: .jar dahil - eƒüer Fabric/Forge mod tutarsanƒ±z bu satƒ±rƒ± d√ºzenleyin!
          # Whitelist yakla≈üƒ±mƒ± i√ßin: sadece .mcfunction, .json, .nbt, .png izin ver
          DANGEROUS_EXTENSIONS=("sh" "js" "exe" "bat" "cmd" "ps1" "py" "rb" "pl" "jar" "dll" "so" "dylib" "vbs" "com" "msi" "app" "deb" "rpm")
          
          DELETED_FILES=()
          
          # Tek find ile t√ºm uzantƒ±larƒ± yakala (performans optimizasyonu)
          FIND_PATTERN=""
          for ext in "${DANGEROUS_EXTENSIONS[@]}"; do
            if [ -z "$FIND_PATTERN" ]; then
              FIND_PATTERN="-name *.$ext"
            else
              FIND_PATTERN="$FIND_PATTERN -o -name *.$ext"
            fi
          done
          
          # Derin tarama: new_versions altƒ±nda datapack i√ßeren HER yol
          while IFS= read -r -d '' file; do
            echo "‚ö†Ô∏è  Found dangerous file: $file"
            
            # PR'da sadece uyar, silme
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              # Dosya uzantƒ±sƒ±nƒ± √ßƒ±kar
              ext="${file##*.}"
              echo "::error file=$file,title=Security: Dangerous file detected::.$ext files are not allowed in Minecraft datapacks for security reasons."
              DELETED_FILES+=("$file")
            else
              # Push'ta sil
              rm -f "$file"
              DELETED_FILES+=("$file")
              echo "üóëÔ∏è  Deleted: $file"
            fi
          done < <(find new_versions -type f \( $FIND_PATTERN \) -path "*datapack*" -print0 2>/dev/null | sort -z -u)
          
          # Sonu√ß
          FILE_COUNT=${#DELETED_FILES[@]}
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "‚úÖ No dangerous files found. Datapack is clean!"
            echo "file_count=0" >> $GITHUB_OUTPUT
          else
            echo "üõ°Ô∏è  Total files found: $FILE_COUNT"
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            
            # Log dosyasƒ± (sƒ±ralƒ±, benzersiz)
            printf '%s\n' "${DELETED_FILES[@]}" | sort -u > deleted_files.log
            
            # PR'da fail ver + kullanƒ±cƒ± dostu mesaj
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "‚õî PR BLOCKED: Security policy violation"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              echo "üìã Found $FILE_COUNT dangerous file(s) in datapack directories."
              echo ""
              echo "üõ°Ô∏è  Security Policy:"
              echo "   Minecraft datapacks should only contain:"
              echo "   ‚Ä¢ .mcfunction (commands)"
              echo "   ‚Ä¢ .json (metadata, recipes, etc.)"
              echo "   ‚Ä¢ .nbt (structure files)"
              echo "   ‚Ä¢ .png (textures, if applicable)"
              echo ""
              echo "   Script files (.sh, .js, .py, etc.) and executables"
              echo "   are prohibited for security reasons."
              echo ""
              echo "üìù Action required:"
              echo "   Please remove the files listed above and push again."
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo ""
              echo "::error::PR contains $FILE_COUNT dangerous file(s). See file annotations and logs above."
              exit 1
            fi
          fi

      - name: Commit changes if files were deleted
        if: github.event_name != 'pull_request' && steps.scan.outputs.file_count != '0'
        run: |
          set -euo pipefail
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -n "$(git status --porcelain)" ]; then
            FILE_COUNT=$(cat deleted_files.log | wc -l)
            
            git add -A
            git commit -m "üõ°Ô∏è Security: Auto-removed $FILE_COUNT dangerous file(s) from datapack

Automated security cleanup by GitHub Actions.
Files containing executable code or scripts are not permitted
in Minecraft datapack directories.

See workflow artifacts for complete deletion log.

Workflow: ${{ github.workflow }}
Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
Commit: ${{ github.sha }}"
            
            git push
            echo "‚úÖ Changes committed and pushed"
          else
            echo "‚úÖ No changes to commit"
          fi

      - name: Upload deletion log
        if: always() && steps.scan.outputs.file_count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: deletion-log-${{ github.run_number }}-${{ github.run_attempt }}
          path: deleted_files.log
          retention-days: 90

      - name: Generate summary
        if: always()
        run: |
          echo "## üõ°Ô∏è Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f deleted_files.log ]; then
            FILE_COUNT=$(cat deleted_files.log | wc -l)
            
            echo "**Scan date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "**Files processed:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "**Event type:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "### ‚õî Action: PR Blocked" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "This pull request contains dangerous files in datapack directories." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Security policy:** Minecraft datapacks should only contain:" >> $GITHUB_STEP_SUMMARY
              echo "- \`.mcfunction\` (command files)" >> $GITHUB_STEP_SUMMARY
              echo "- \`.json\` (metadata, recipes, advancements)" >> $GITHUB_STEP_SUMMARY
              echo "- \`.nbt\` (structure files)" >> $GITHUB_STEP_SUMMARY
              echo "- \`.png\` (textures)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Script files and executables are prohibited." >> $GITHUB_STEP_SUMMARY
            else
              echo "### ‚úÖ Action: Files Automatically Removed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Dangerous files were detected and automatically removed from the repository." >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üóëÔ∏è Affected files (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # ƒ∞lk 50 dosya
            head -n 50 deleted_files.log >> $GITHUB_STEP_SUMMARY
            
            # 50'den fazlaysa
            if [ $FILE_COUNT -gt 50 ]; then
              REMAINING=$((FILE_COUNT - 50))
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "... and $REMAINING more file(s)" >> $GITHUB_STEP_SUMMARY
              echo "(Download artifact 'deletion-log-${{ github.run_number }}-${{ github.run_attempt }}' for complete list)" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            
            # Uzantƒ± istatistikleri
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üìä File type breakdown</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            awk -F. '{print $NF}' deleted_files.log | sort | uniq -c | sort -rn >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Scan date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚úÖ Clean" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No dangerous files found in datapack directories. Repository is secure." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow: \`${{ github.workflow }}\` ‚Ä¢ Run #${{ github.run_number }}*" >> $GITHUB_STEP_SUMMARY
