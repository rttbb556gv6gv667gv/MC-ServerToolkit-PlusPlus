name: Validate Datapack

on:
  pull_request:
    paths:
      - 'new_versions/**/datapack/**'
      - '.github/workflows/validate-datapack.yml'
  push:
    branches:
      - main
    paths:
      - 'new_versions/**/datapack/**'
      - '.github/workflows/validate-datapack.yml'
  workflow_dispatch:

env:
  STRICT_MODE: false  # true = unknown commands fail, false = warnings only
  TARGET: release     # release | snapshot

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq tree
          echo "âœ… Dependencies installed"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # COMBINED VALIDATION - All checks in one step for better UI
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Validate Datapack (All Checks)
        run: |
          set -e  # Exit on first error
          
          TOTAL_ERRORS=0
          TOTAL_WARNINGS=0
          
          # Valid pack formats for Minecraft 1.21+
          VALID_FORMATS=(48 81 88 94)  # 48=1.21, 81=1.21.2, 88=1.21.4, 94=1.21.5
          INVALID_THRESHOLD=47
          
          # Create cache directory
          mkdir -p /tmp/pack_formats
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ DATAPACK VALIDATION STARTED (Minecraft 1.21+)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # 1. JSON SYNTAX VALIDATION
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” [1/6] Validating JSON Files..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          json_error=0
          json_count=0
          failed_files=()
          
          while IFS= read -r -d $'\0' file; do
            json_count=$((json_count + 1))
            if ! jq empty "$file" 2>/dev/null; then
              echo "  âŒ Invalid JSON: $file"
              failed_files+=("$file")
              json_error=1
            fi
          done < <(find new_versions -name "*.json" -type f -print0)
          
          if [ $json_error -eq 0 ]; then
            echo "  âœ… All $json_count JSON files are valid"
          else
            echo "  âŒ Failed: ${#failed_files[@]} file(s)"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # 2. PACK.MCMETA VALIDATION
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ [2/6] Validating pack.mcmeta..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          mcmeta_error=0
          mcmeta_warnings=0
          mcmeta_count=0
          
          while IFS= read -r -d $'\0' file; do
            mcmeta_count=$((mcmeta_count + 1))
            datapack_root=$(dirname "$file")
            datapack_id=$(echo "$datapack_root" | md5sum | cut -d' ' -f1)
            
            echo "  ğŸ“¦ $file"
            
            if ! jq -e '.pack.pack_format' "$file" > /dev/null 2>&1; then
              echo "     âŒ Missing pack.pack_format"
              mcmeta_error=1
              continue
            fi
            
            pack_format=$(jq -r '.pack.pack_format' "$file")
            echo "$pack_format:$datapack_root" > "/tmp/pack_formats/${datapack_id}.txt"
            
            is_valid=0
            for valid_format in "${VALID_FORMATS[@]}"; do
              if [ "$pack_format" -eq "$valid_format" ] 2>/dev/null; then
                is_valid=1
                break
              fi
            done
            
            if [ $is_valid -eq 1 ]; then
              echo "     âœ… Pack format: $pack_format"
            elif [ "$pack_format" -le "$INVALID_THRESHOLD" ] 2>/dev/null; then
              echo "     âŒ Invalid pack_format $pack_format (must be 48, 81, 88, or 94)"
              mcmeta_error=1
            else
              echo "     âš ï¸  Unknown pack_format: $pack_format"
              mcmeta_warnings=$((mcmeta_warnings + 1))
            fi
            
            # Check description
            if ! jq -e '.pack.description' "$file" > /dev/null 2>&1; then
              echo "     âš ï¸  Missing pack.description (recommended)"
              mcmeta_warnings=$((mcmeta_warnings + 1))
            fi
            
          done < <(find new_versions -path "*/datapack/pack.mcmeta" -type f -print0)
          
          if [ $mcmeta_count -eq 0 ]; then
            echo "  âŒ No pack.mcmeta files found"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          elif [ $mcmeta_error -eq 0 ]; then
            echo "  âœ… All pack.mcmeta files valid"
            [ $mcmeta_warnings -gt 0 ] && echo "  âš ï¸  $mcmeta_warnings warning(s)"
          else
            echo "  âŒ pack.mcmeta validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          TOTAL_WARNINGS=$((TOTAL_WARNINGS + mcmeta_warnings))
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # 3. DATAPACK STRUCTURE
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ [3/6] Validating Structure..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          struct_error=0
          datapack_count=0
          
          while IFS= read -r -d $'\0' file; do
            dir=$(dirname "$file")
            datapack_count=$((datapack_count + 1))
            
            if [ ! -d "$dir/data" ]; then
              echo "  âŒ Missing data/ in: $dir"
              struct_error=1
            else
              namespace_count=$(find "$dir/data" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
              echo "  âœ… Datapack: $dir ($namespace_count namespace(s))"
              
              # Check for common folders
              while IFS= read -r -d $'\0' namespace; do
                ns_name=$(basename "$namespace")
                echo "     ğŸ“‚ Namespace: $ns_name"
                
                [ -d "$namespace/function" ] && echo "        âš™ï¸  functions/"
                [ -d "$namespace/advancement" ] && echo "        ğŸ† advancements/"
                [ -d "$namespace/loot_table" ] && echo "        ğŸ loot_tables/"
                [ -d "$namespace/recipe" ] && echo "        ğŸ“œ recipes/"
                [ -d "$namespace/predicate" ] && echo "        ğŸ” predicates/"
                [ -d "$namespace/tag" ] && echo "        ğŸ·ï¸  tags/"
                [ -d "$namespace/structure" ] && echo "        ğŸ—ï¸  structures/"
                [ -d "$namespace/worldgen" ] && echo "        ğŸŒ worldgen/"
                [ -d "$namespace/item_modifier" ] && echo "        âœ¨ item_modifiers/"
                [ -d "$namespace/chat_type" ] && echo "        ğŸ’¬ chat_types/"
                [ -d "$namespace/damage_type" ] && echo "        âš”ï¸  damage_types/"
                [ -d "$namespace/enchantment" ] && echo "        âœ¨ enchantments/"
                [ -d "$namespace/jukebox_song" ] && echo "        ğŸµ jukebox_songs/"
                
              done < <(find "$dir/data" -mindepth 1 -maxdepth 1 -type d -print0)
            fi
          done < <(find new_versions -path "*/datapack/pack.mcmeta" -type f -print0)
          
          if [ $struct_error -eq 0 ]; then
            echo "  âœ… Structure validation passed"
          else
            echo "  âŒ Structure validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # 4. FUNCTION FILES VALIDATION (ENHANCED FOR 1.21)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš™ï¸  [4/6] Validating Functions..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          func_error=0
          func_warnings=0
          total_funcs=0
          total_commands=0
          
          # Enhanced command compatibility matrix for 1.21+
          declare -A command_min_format
          # Core commands (all versions)
          command_min_format["say"]=1
          command_min_format["tellraw"]=1
          command_min_format["execute"]=1
          command_min_format["scoreboard"]=1
          command_min_format["function"]=1
          command_min_format["gamemode"]=1
          command_min_format["give"]=1
          command_min_format["kill"]=1
          command_min_format["summon"]=1
          command_min_format["tp"]=1
          command_min_format["teleport"]=1
          command_min_format["time"]=1
          command_min_format["weather"]=1
          command_min_format["fill"]=1
          command_min_format["setblock"]=1
          command_min_format["clone"]=1
          command_min_format["playsound"]=1
          command_min_format["particle"]=1
          command_min_format["effect"]=1
          command_min_format["enchant"]=1
          command_min_format["xp"]=1
          command_min_format["experience"]=1
          command_min_format["clear"]=1
          command_min_format["tag"]=1
          command_min_format["team"]=1
          command_min_format["title"]=1
          command_min_format["trigger"]=1
          command_min_format["attribute"]=1
          command_min_format["bossbar"]=1
          command_min_format["data"]=1
          command_min_format["datapack"]=1
          command_min_format["worldborder"]=1
          command_min_format["schedule"]=1
          command_min_format["forceload"]=1
          command_min_format["locatebiome"]=1
          command_min_format["locate"]=1
          command_min_format["spectate"]=1
          command_min_format["spawnpoint"]=1
          command_min_format["setworldspawn"]=1
          
          # 1.21.2+ commands (pack_format 81+)
          command_min_format["item"]=81
          command_min_format["damage"]=81
          command_min_format["ride"]=81
          command_min_format["return"]=81
          command_min_format["tick"]=81
          command_min_format["random"]=81
          
          # 1.21 new/updated commands (pack_format 48+)
          command_min_format["transfer"]=48  # New in 1.21
          
          declare -A deprecated_commands
          deprecated_commands["replaceitem"]="Use /item replace (requires pack_format 81+)"
          
          # New 1.21 execute subcommands
          declare -A execute_subcommands
          execute_subcommands["if biome"]=81
          execute_subcommands["unless biome"]=81
          execute_subcommands["if loaded"]=48
          execute_subcommands["unless loaded"]=48
          execute_subcommands["if dimension"]=1
          execute_subcommands["unless dimension"]=1
          execute_subcommands["on"]=48  # execute on <relation>
          
          while IFS= read -r -d $'\0' file; do
            total_funcs=$((total_funcs + 1))
            
            # Find pack format
            current_pack_format=0
            file_dir="$file"
            while [ "$file_dir" != "/" ] && [ "$file_dir" != "." ]; do
              if [ -f "$file_dir/pack.mcmeta" ]; then
                datapack_id=$(echo "$file_dir" | md5sum | cut -d' ' -f1)
                if [ -f "/tmp/pack_formats/${datapack_id}.txt" ]; then
                  current_pack_format=$(cut -d':' -f1 "/tmp/pack_formats/${datapack_id}.txt")
                fi
                break
              fi
              file_dir=$(dirname "$file_dir")
            done
            
            relative_path=$(echo "$file" | sed "s|^$(pwd)/||")
            file_cmd_count=0
            line_num=0
            
            while IFS= read -r line; do
              line_num=$((line_num + 1))
              [[ "$line" =~ ^[[:space:]]*$ ]] && continue
              [[ "$line" =~ ^[[:space:]]*# ]] && continue
              
              file_cmd_count=$((file_cmd_count + 1))
              total_commands=$((total_commands + 1))
              
              clean_line=$(echo "$line" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
              [[ "$clean_line" =~ ^/ ]] && clean_line="${clean_line:1}"
              cmd=$(echo "$clean_line" | awk '{print $1}')
              
              # Check deprecated
              if [ -n "${deprecated_commands[$cmd]}" ]; then
                echo "  âŒ $relative_path:$line_num - Deprecated: /$cmd"
                echo "     ğŸ’¡ ${deprecated_commands[$cmd]}"
                func_error=1
                continue
              fi
              
              # Check compatibility
              if [ -n "${command_min_format[$cmd]}" ]; then
                required_format="${command_min_format[$cmd]}"
                if [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt "$required_format" ]; then
                  echo "  âŒ $relative_path:$line_num - /$cmd requires pack_format $required_format+"
                  func_error=1
                fi
              elif [ "$STRICT_MODE" = "true" ]; then
                echo "  âš ï¸  $relative_path:$line_num - Unknown command: /$cmd"
                func_warnings=$((func_warnings + 1))
              fi
              
              # Execute subcommand checks
              if [[ "$clean_line" =~ ^execute ]]; then
                for sub in "${!execute_subcommands[@]}"; do
                  if [[ "$clean_line" =~ $sub ]]; then
                    required="${execute_subcommands[$sub]}"
                    if [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt "$required" ]; then
                      echo "  âŒ $relative_path:$line_num - 'execute $sub' requires pack_format $required+"
                      func_error=1
                    fi
                  fi
                done
                
                # Check for execute on <relation>
                if [[ "$clean_line" =~ execute[[:space:]]+on[[:space:]]+(attacker|controller|leasher|origin|owner|passengers|target|vehicle) ]]; then
                  if [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt 48 ]; then
                    echo "  âŒ $relative_path:$line_num - 'execute on <relation>' requires pack_format 48+"
                    func_error=1
                  fi
                fi
              fi
              
              # Check for transfer command (new in 1.21)
              if [[ "$cmd" == "transfer" ]]; then
                if [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt 48 ]; then
                  echo "  âŒ $relative_path:$line_num - /transfer requires pack_format 48+ (Minecraft 1.21)"
                  func_error=1
                fi
              fi
              
            done < "$file"
            
            [ $file_cmd_count -gt 0 ] && echo "  âœ“ $relative_path ($file_cmd_count commands)"
            
          done < <(find new_versions -path "*/datapack/data/*/function/*.mcfunction" -type f -print0)
          
          echo "  ğŸ“Š Total: $total_funcs files, $total_commands commands"
          
          if [ $func_error -eq 0 ]; then
            echo "  âœ… Function validation passed"
            [ $func_warnings -gt 0 ] && echo "  âš ï¸  $func_warnings warning(s)"
          else
            echo "  âŒ Function validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          TOTAL_WARNINGS=$((TOTAL_WARNINGS + func_warnings))
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # 5. MACRO VALIDATION
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ [5/6] Validating Macros..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          macro_error=0
          files_with_macros=0
          total_macro_vars=0
          
          while IFS= read -r -d $'\0' file; do
            current_pack_format=0
            file_dir="$file"
            while [ "$file_dir" != "/" ] && [ "$file_dir" != "." ]; do
              if [ -f "$file_dir/pack.mcmeta" ]; then
                datapack_id=$(echo "$file_dir" | md5sum | cut -d' ' -f1)
                if [ -f "/tmp/pack_formats/${datapack_id}.txt" ]; then
                  current_pack_format=$(cut -d':' -f1 "/tmp/pack_formats/${datapack_id}.txt")
                fi
                break
              fi
              file_dir=$(dirname "$file_dir")
            done
            
            relative_path=$(echo "$file" | sed "s|^$(pwd)/||")
            macro_vars=$(grep -oP '\$\(\K[a-zA-Z0-9_]+(?=\))' "$file" 2>/dev/null | sort -u)
            macro_count=$(echo "$macro_vars" | grep -c '.' 2>/dev/null || echo 0)
            
            if [ $macro_count -gt 0 ]; then
              files_with_macros=$((files_with_macros + 1))
              total_macro_vars=$((total_macro_vars + macro_count))
              
              echo "  ğŸ”§ $relative_path ($macro_count macro variable(s))"
              echo "$macro_vars" | while read -r var; do
                [ -n "$var" ] && echo "     â€¢ \$($var)"
              done
              
              if [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt 81 ]; then
                echo "     âŒ Macros require pack_format 81+ (current: $current_pack_format)"
                macro_error=1
              fi
            fi
          done < <(find new_versions -path "*/datapack/data/*/function/*.mcfunction" -type f -print0)
          
          if [ $macro_error -eq 0 ]; then
            if [ $files_with_macros -eq 0 ]; then
              echo "  â„¹ï¸  No macros detected"
            else
              echo "  âœ… Macro validation passed ($files_with_macros files, $total_macro_vars variables)"
            fi
          else
            echo "  âŒ Macro validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # 6. DIALOG & CHAT TYPE VALIDATION (NEW IN 1.21)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¬ [6/6] Validating Dialogs & Chat Types..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          dialog_error=0
          dialog_warnings=0
          dialog_count=0
          chat_type_count=0
          
          # Validate chat_type JSON files
          while IFS= read -r -d $'\0' file; do
            chat_type_count=$((chat_type_count + 1))
            relative_path=$(echo "$file" | sed "s|^$(pwd)/||")
            
            echo "  ğŸ’¬ $relative_path"
            
            # Check required fields for chat_type
            if ! jq -e '.chat' "$file" > /dev/null 2>&1; then
              echo "     âŒ Missing 'chat' field"
              dialog_error=1
            fi
            
            if ! jq -e '.narration' "$file" > /dev/null 2>&1; then
              echo "     âš ï¸  Missing 'narration' field (optional but recommended)"
              dialog_warnings=$((dialog_warnings + 1))
            fi
            
            # Validate translation keys
            if jq -e '.chat.translation_key' "$file" > /dev/null 2>&1; then
              trans_key=$(jq -r '.chat.translation_key' "$file")
              echo "     âœ“ Translation key: $trans_key"
            fi
            
          done < <(find new_versions -path "*/datapack/data/*/chat_type/*.json" -type f -print0 2>/dev/null)
          
          # Check for dialog command usage in functions
          while IFS= read -r -d $'\0' file; do
            if grep -q "^\s*dialog\s" "$file" 2>/dev/null; then
              dialog_count=$((dialog_count + 1))
              relative_path=$(echo "$file" | sed "s|^$(pwd)/||")
              
              # Find pack format
              current_pack_format=0
              file_dir="$file"
              while [ "$file_dir" != "/" ] && [ "$file_dir" != "." ]; do
                if [ -f "$file_dir/pack.mcmeta" ]; then
                  datapack_id=$(echo "$file_dir" | md5sum | cut -d' ' -f1)
                  if [ -f "/tmp/pack_formats/${datapack_id}.txt" ]; then
                    current_pack_format=$(cut -d':' -f1 "/tmp/pack_formats/${datapack_id}.txt")
                  fi
                  break
                fi
                file_dir=$(dirname "$file_dir")
              done
              
              echo "  ğŸ—¨ï¸  $relative_path uses /dialog command"
              
              # Dialog command requires 1.21+ (pack_format 48+)
              if [ "$current_pack_format" -gt 0 ] && [ "$current_pack_format" -lt 48 ]; then
                echo "     âŒ /dialog requires pack_format 48+ (Minecraft 1.21)"
                dialog_error=1
              fi
            fi
          done < <(find new_versions -path "*/datapack/data/*/function/*.mcfunction" -type f -print0)
          
          if [ $dialog_error -eq 0 ]; then
            if [ $chat_type_count -eq 0 ] && [ $dialog_count -eq 0 ]; then
              echo "  â„¹ï¸  No dialogs or custom chat types detected"
            else
              echo "  âœ… Dialog validation passed"
              [ $chat_type_count -gt 0 ] && echo "     ğŸ“ Chat types: $chat_type_count"
              [ $dialog_count -gt 0 ] && echo "     ğŸ—¨ï¸  Dialog commands: $dialog_count"
              [ $dialog_warnings -gt 0 ] && echo "  âš ï¸  $dialog_warnings warning(s)"
            fi
          else
            echo "  âŒ Dialog validation failed"
            TOTAL_ERRORS=$((TOTAL_ERRORS + 1))
          fi
          TOTAL_WARNINGS=$((TOTAL_WARNINGS + dialog_warnings))
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # FINAL SUMMARY
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ VALIDATION SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "  ğŸ“¦ Datapacks:      $datapack_count"
          echo "  ğŸ“„ JSON files:     $json_count"
          echo "  âš™ï¸  Functions:      $total_funcs"
          echo "  ğŸ’¬ Commands:       $total_commands"
          echo "  ğŸ”§ With macros:    $files_with_macros"
          echo "  ğŸ’¬ Chat types:     $chat_type_count"
          echo "  ğŸ—¨ï¸  Dialog usage:   $dialog_count"
          echo ""
          
          if [ $TOTAL_ERRORS -eq 0 ]; then
            echo "  âœ… ALL VALIDATIONS PASSED"
            [ $TOTAL_WARNINGS -gt 0 ] && echo "  âš ï¸  $TOTAL_WARNINGS warning(s) detected"
            echo ""
            echo "  ğŸš€ Datapack is production-ready for Minecraft 1.21+"
          else
            echo "  âŒ VALIDATION FAILED"
            echo "  âŒ Errors: $TOTAL_ERRORS"
            echo "  âš ï¸  Warnings: $TOTAL_WARNINGS"
            echo ""
            echo "  Common issues:"
            echo "    â€¢ pack_format must be 48, 81, 88, or 94"
            echo "    â€¢ Commands must match pack_format requirements"
            echo "    â€¢ Macros require pack_format 81+"
            echo "    â€¢ /dialog and /transfer require pack_format 48+ (1.21)"
            echo "    â€¢ execute on <relation> requires pack_format 48+"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Exit with error if any validation failed
          [ $TOTAL_ERRORS -gt 0 ] && exit 1
          exit 0

      - name: Upload Validation Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: validation-logs
          path: |
            new_versions/**/datapack/**/*.json
            new_versions/**/datapack/**/*.mcfunction
          retention-days: 7
